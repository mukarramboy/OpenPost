{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow-lg rounded-2xl p-6 mt-6">

  <!-- Пост -->
  <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ post.title }}</h1>
  <div class="flex items-center text-sm text-gray-500 mb-4">
    <span>Автор: <strong>{{ post.author.username }}</strong></span>
    <span class="mx-2">•</span>
    <span>Опубликовано: {{ post.created_at|date:"d.m.Y H:i" }}</span>
    {% if post.updated_at > post.created_at %}
      <span class="mx-2">•</span>
      <span>Обновлено: {{ post.updated_at|date:"d.m.Y H:i" }}</span>
    {% endif %}
  </div>

  <div class="prose max-w-none mb-6">
    {{ post.content.html|safe }}
  </div>

  <!-- Комментарии -->
  <div class="flex-1 overflow-y-auto p-6 space-y-6">
    <h2 class="text-lg font-semibold text-gray-800">Комментарии</h2>

    {% for comment in post.comments.all %}
    {% if not comment.parent %}
      <div class="flex items-start space-x-3 mb-6">
        <!-- Аватар -->
        <img src="https://ui-avatars.com/api/?name={{ comment.user.username }}&background=random"
             alt="{{ comment.user.username }}"
             class="w-9 h-9 rounded-full">

        <!-- Контент -->
        <div class="flex-1">
          <!-- Имя + текст -->
          <p>
            <span class="font-semibold mr-2">{{ comment.user.username }}</span>
            <span class="text-gray-800">{{ comment.content }}</span>
          </p>

          <!-- Дата + лайки + ответ -->
          <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
            <span>{{ comment.created_at|timesince }} назад</span>

            <!-- Лайк -->
            <form method="post" action="{% url 'like_comment' comment.pk %}">
              {% csrf_token %}
              <button type="submit" class="hover:text-red-500 flex items-center space-x-1">
                <span>❤️</span>
                <span>{{ comment.likes_count }}</span>
              </button>
            </form>

            <!-- Ответ -->
            <button class="hover:underline"
                    onclick="document.getElementById('reply-form-{{ comment.id }}').classList.toggle('hidden')">
              Ответить
            </button>
          </div>

          <!-- Кнопка показать ответы -->
          {% if comment.replies.all %}
            <button onclick="toggleReplies({{ comment.id }})"
                    class="flex items-center text-xs text-blue-500 mt-2 hover:underline"
                    id="toggle-btn-{{ comment.id }}">
              <span>Показать ответы ({{ comment.replies.count }})</span>
              <span class="ml-1 transition-transform" id="arrow-{{ comment.id }}">⮟</span>
            </button>
          {% endif %}

          <!-- Блок с ответами (скрыт по умолчанию) -->
          <div id="replies-{{ comment.id }}" class="max-h-0 overflow-hidden transition-all duration-500 ease-in-out mt-2 space-y-3">
            {% for reply in comment.replies.all %}
              <div class="flex items-start space-x-3 ml-8 border-l border-gray-200 pl-3">
                <img src="https://ui-avatars.com/api/?name={{ reply.user.username }}&background=random"
                     alt="{{ reply.user.username }}"
                     class="w-7 h-7 rounded-full">
                <div class="flex-1">
                  <p>
                    <span class="font-semibold mr-2">{{ reply.user.username }}</span>
                    <span class="text-gray-800">{{ reply.content }}</span>
                  </p>
                  <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                    <span>{{ reply.created_at|timesince }} назад</span>
                    <form method="post" action="{% url 'like_comment' reply.pk %}">
                      {% csrf_token %}
                      <button type="submit" class="hover:text-red-500 flex items-center space-x-1">
                        <span>❤️</span>
                        <span>{{ reply.likes_count }}</span>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Форма ответа -->
          <form id="reply-form-{{ comment.id }}"
                method="post"
                action="{% url 'add_comment' post.pk %}"
                class="hidden mt-2">
            {% csrf_token %}
            <input type="hidden" name="parent" value="{{ comment.id }}">
            <textarea name="content" rows="1"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none text-sm"
              placeholder="Напишите ответ..."></textarea>
            <button type="submit"
              class="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition text-sm">
              Ответить
            </button>
          </form>
        </div>
      </div>
    {% endif %}
    {% endfor %}

    {% if not post.comments.all %}
      <p class="text-gray-500">Комментариев пока нет. Будьте первым!</p>
    {% endif %}
  </div>

  <!-- Форма для нового комментария -->
  <div class="mt-6">
    <h3 class="text-xl font-semibold mb-2">Оставить комментарий</h3>
    <form method="post" action="{% url 'add_comment' post.pk %}">
      {% csrf_token %}
      <textarea name="content" rows="3"
        class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400 focus:outline-none"
        placeholder="Напишите комментарий..."></textarea>
      <button type="submit"
        class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
        Отправить
      </button>
    </form>
  </div>

</div>

<!-- JS -->
<script>
function toggleReplies(commentId) {
  const replies = document.getElementById(`replies-${commentId}`);
  const button = document.getElementById(`toggle-btn-${commentId}`);
  const arrow = document.getElementById(`arrow-${commentId}`);

  if (replies.classList.contains("max-h-0")) {
    replies.classList.remove("max-h-0");
    replies.classList.add("max-h-screen");
    button.firstElementChild.innerText = "Скрыть ответы";
    arrow.style.transform = "rotate(180deg)";
  } else {
    replies.classList.remove("max-h-screen");
    replies.classList.add("max-h-0");
    button.firstElementChild.innerText = `Показать ответы (${replies.childElementCount})`;
    arrow.style.transform = "rotate(0deg)";
  }
}
</script>
{% endblock %}
